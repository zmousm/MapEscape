(function(b){MapEscape=function(d,a){var e=b(d);b.extend(this,{mapWrapperCssClass:"map-wrapper",scrollAreaCssClass:"mapescape-scroll",scrollTabCssClass:"mapescape-scroll-tab",helperCSSClass:"scroll-active",init:function(){this.initScrollHelper();var c="";a.scrollFollow&&(c="scroll ");b(window).on(c+"resize orientationchange",b.proxy(this,"toggleScrollHelperOn"))},initScrollHelper:function(){this.$scrollHelper=b('<div class="'+this.scrollAreaCssClass+" "+a.hiddenClass+'"></div>');this.$scrollHelperTab=b('<div class="'+this.scrollTabCssClass+'"></div>');a.scrollText&&this.$scrollHelperTab.text(a.scrollText);this.addScrollHelper()},addScrollHelper:function(){e.wrap('<div class="'+this.mapWrapperCssClass+'"></div>');this.$scrollHelper.insertAfter(e);this.$scrollHelper.html(this.$scrollHelperTab);this.mapControls=this.$scrollHelper.css("top");"auto"===this.mapControls&&(this.mapControls=0,this.$scrollHelper.css({top:"0"}));var c=e.height();"undefined"===!typeof Zepto&&(c=e.outerHeight());this.mapHeight=c-parseInt(this.mapControls);this.$scrollHelper.height(this.mapHeight);this.$scrollHelper.on("touchstart mousedown",b.proxy(this,"touchstartHandler"));this.$scrollHelper.on("touchend mouseup",b.proxy(this,"touchendHandler"));a.tabCenter&&this.positionScrollTab();this.toggleScrollHelperOn()},positionScrollTab:function(){this.tabHeight=this.$scrollHelperTab.height();"undefined"===!typeof Zepto&&(this.tabHeight=this.$scrollHelperTab.outerHeight());this.pos=this.mapHeight/2-this.tabHeight/2;this.$scrollHelperTab.css({top:this.pos+"px"})},checkMapVsWindow:function(){var c=b(window).height(),a=b(window).scrollTop(),a=e.offset().top-a,d=a+(this.mapHeight+parseInt(this.mapControls));if(0>=a){var f=(this.mapHeight-a)/2-this.tabHeight/2;this.pos=f+this.tabHeight>this.mapHeight?this.mapHeight-this.tabHeight:f}d>c&&(f=(this.mapHeight-(a+this.mapHeight-c))/2-this.tabHeight/2,this.pos=0>f?0:f);0>a&&d>c&&(this.pos=f=Math.abs(a)+c/2-this.tabHeight/2);this.$scrollHelperTab.css({top:this.pos+"px"})},toggleScrollHelperOn:function(){if(a.alwaysOn)this.showScrollHelper();else{this.checkMapVsWindow();var c=e.offset().top+(this.mapHeight+parseInt(this.mapControls))+a.threshhold,d=b(window).height();"undefined"===!typeof Zepto&&(d=b(window).innerHeight());c>d?this.showScrollHelper():this.removeScrollHelper()}},removeScrollHelper:function(){this.$scrollHelper.addClass(a.hiddenClass);"function"===typeof a.callback&&a.callback(!1)},showScrollHelper:function(){this.$scrollHelper.removeClass(a.hiddenClass);"function"===typeof a.callback&&a.callback(!0)},touchstartHandler:function(a){b(a.currentTarget).addClass(this.helperCSSClass)},touchendHandler:function(a){b(a.currentTarget).removeClass(this.helperCSSClass)}});this.init()};b.fn.mapescape=function(d){return this.each(function(){var a=b(this),e={alwaysOn:!1,hiddenClass:"scroll-inactive",scrollText:null,threshhold:0,tabCenter:!0,scrollFollow:!0,callback:void 0};d&&b.extend(e,d);new MapEscape(a,e)})}})(window.jQuery||window.Zepto);